<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Canvas Infinito: Sistema Completo</title>
    <style>
        /* --- CSS: VISUAL GERAL --- */
        body, html {
            margin: 0; padding: 0; width: 100%; height: 100%;
            overflow: hidden; background-color: #121212;
            font-family: 'Segoe UI', sans-serif; color: #e0e0e0;
        }

        /* SIDEBAR */
        #sidebar {
            position: fixed; top: 0; left: 0; bottom: 0; width: 60px;
            background: #1e1e1e; border-right: 1px solid #333;
            display: flex; flex-direction: column; align-items: center; 
            padding-top: 20px; z-index: 2000; box-shadow: 2px 0 10px rgba(0,0,0,0.5);
        }
        .tool-btn {
            width: 40px; height: 40px; margin-bottom: 15px; border-radius: 8px;
            border: 1px solid transparent; background: #2c2c2c; color: #fff;
            font-size: 20px; cursor: pointer; transition: all 0.2s;
        }
        .tool-btn:hover { background: #333; border-color: #555; }

        /* BREADCRUMBS */
        #breadcrumbs {
            position: fixed; top: 15px; left: 80px; 
            z-index: 2001; font-size: 16px; font-weight: 500; color: #666;
            pointer-events: none;
        }
        .crumb { pointer-events: auto; cursor: pointer; color: #888; transition: color 0.2s; }
        .crumb:hover { color: #bb86fc; text-decoration: underline; }
        .crumb.active { color: #e0e0e0; cursor: default; text-decoration: none; font-weight: bold;}
        .crumb-separator { margin: 0 8px; color: #444; }

        /* VIEWPORT & WORLD */
        #viewport {
            position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            overflow: hidden; cursor: default;
            background-color: #121212;
            background-image: radial-gradient(circle, #333 1px, transparent 1px);
            background-size: 40px 40px; 
        }
        #world {
            position: absolute; top: 0; left: 0; width: 0; height: 0;
            overflow: visible; transform-origin: 0 0;
        }

        /* LAYER DE DOCUMENTO (EDITOR DE TEXTO) */
        #doc-layer {
            display: none; position: absolute; top: 0; left: 60px; right: 0; bottom: 0;
            background-color: #181818; z-index: 10; overflow-y: auto;
        }
        #doc-layer.active { display: block; }
        .doc-container {
            max-width: 800px; margin: 0 auto; padding: 40px;
            display: flex; flex-direction: column; gap: 20px;
        }
        #doc-title {
            background: transparent; border: none; border-bottom: 2px solid #333;
            color: #fff; font-size: 2.5rem; font-weight: bold; padding: 10px 0;
            outline: none; width: 100%;
        }
        #doc-body {
            background: transparent; border: none; color: #ddd; font-size: 1.1rem; 
            line-height: 1.6; outline: none; width: 100%; height: 70vh; resize: none;
        }

        /* SVG CONEX√ïES */
        #connections-layer {
            position: absolute; top: -50000px; left: -50000px; 
            width: 100000px; height: 100000px; 
            overflow: visible; pointer-events: none; z-index: 0;
        }
        .connector-line { 
            fill: none; stroke: #666; stroke-width: 3px; stroke-linecap: round; transition: stroke 0.2s;
        }
        .connector-line:hover { stroke: #bb86fc; }

        /* CARDS */
        .card {
            position: absolute; background: #1e1e1e; border: 1px solid #333;
            box-shadow: 0 10px 20px rgba(0,0,0,0.5); border-radius: 12px; padding: 20px;
            user-select: none; cursor: move; min-width: 150px; z-index: 1;
            transition: transform 0.1s, box-shadow 0.2s;
        }
        .card:hover { border-color: #555; }
        .card.dragging { border-color: #bb86fc; z-index: 1000; cursor: grabbing; }
        .card h2 { margin: 0 0 5px 0; font-size: 1rem; color: #fff; pointer-events: none; }
        .card p { margin: 0; color: #888; font-size: 0.9rem; pointer-events: none; }

        /* MENUS */
        #context-menu, #connection-picker {
            display: none; position: fixed; background: #252525;
            border: 1px solid #444; border-radius: 8px; z-index: 5000;
        }
        #context-menu { box-shadow: 0 5px 15px rgba(0,0,0,0.5); padding: 5px 0; min-width: 150px; }
        .menu-item { padding: 10px 20px; cursor: pointer; color: #e0e0e0; font-size: 0.9rem; }
        .menu-item:hover { background: #bb86fc; color: #000; }
        #connection-picker {
            top: 50%; left: 50%; transform: translate(-50%, -50%);
            padding: 20px; border: 1px solid #bb86fc; max-height: 300px; overflow-y: auto;
            box-shadow: 0 0 50px rgba(0,0,0,0.8); z-index: 6000;
        }
        .picker-option { padding: 10px; border-bottom: 1px solid #333; cursor: pointer; color: #e0e0e0;}
        .picker-option:hover { background: #333; }
        #hud { position: fixed; bottom: 20px; right: 20px; background: #1e1e1e; padding: 10px 15px; border-radius: 30px; border: 1px solid #333; font-size: 0.8rem; color: #666; pointer-events: none; }
    </style>
</head>
<body>

    <div id="breadcrumbs"><span class="crumb active">Brain</span></div>
    <div id="sidebar"></div>

    <div id="viewport">
        <div id="world">
            <svg id="connections-layer"></svg>
            <div id="card-root" class="card" data-type="text" data-x="300" data-y="200" style="transform: translate(300px, 200px);">
                <div class="card-content">
                    <h2>Bem-vindo</h2>
                    <p>Duplo clique para editar este texto.</p>
                </div>
            </div>
        </div>
        <div id="hud">Zoom: <span id="zoom-level">100%</span></div>
    </div>

    <div id="doc-layer">
        <div class="doc-container">
            <input type="text" id="doc-title" placeholder="T√≠tulo">
            <textarea id="doc-body" placeholder="Escreva aqui..."></textarea>
            <button onclick="closeDocMode()" style="background:#333; color:#fff; border:none; padding:10px; cursor:pointer;">Voltar para o Brain</button>
        </div>
    </div>

    <div id="context-menu"></div>
    <div id="connection-picker">
        <h3 style="color:#fff; margin-top:0;">Conectar com:</h3>
        <div id="picker-list"></div>
        <button onclick="closePicker()" style="margin-top:10px; width:100%; padding: 5px; cursor: pointer;">Cancelar</button>
    </div>

    <script>
        // =========================================================
        // 1. ENGINE PRINCIPAL (O C√ìDIGO QUE VOC√ä N√ÉO PRECISA MEXER)
        // =========================================================
        
        const viewport = document.getElementById('viewport');
        const world = document.getElementById('world');
        const sidebar = document.getElementById('sidebar');
        const svgLayer = document.getElementById('connections-layer');
        const contextMenu = document.getElementById('context-menu');
        const docLayer = document.getElementById('doc-layer');
        const docTitle = document.getElementById('doc-title');
        const docBody = document.getElementById('doc-body');
        const breadcrumbsBar = document.getElementById('breadcrumbs');

        const state = { scale: 1, x: 0, y: 0, isPanning: false, panStartX: 0, panStartY: 0, draggedCard: null, mouseStartX: 0, mouseStartY: 0 };
        
        let currentLayerID = 'root';
        let layerStack = []; 
        let layerStorage = { 'root': { type: 'canvas', elements: [], connections: [] } };
        let currentConnections = []; 
        let contextTargetID = null;
        let activeDocCardReference = null;

        // --- API DE PLUGINS (Dispon√≠vel Globalmente) ---
        window.pluginActions = {}; // Guarda a√ß√µes de duplo clique

        window.registerPlugin = function(icon, tooltip, action) {
            const btn = document.createElement('button');
            btn.className = 'tool-btn';
            btn.innerHTML = icon;
            btn.title = tooltip;
            btn.onclick = (e) => { e.stopPropagation(); action(); };
            sidebar.appendChild(btn);
        };

        window.spawnCardAtCenter = function(html, type = 'default') {
            const cx = ((window.innerWidth - 60) / 2 - state.x) / state.scale;
            const cy = (window.innerHeight / 2 - state.y) / state.scale;
            const el = document.createElement('div');
            el.className = 'card';
            el.id = 'c-' + Date.now() + Math.random().toString(16).slice(2);
            el.setAttribute('data-type', type); // Importante: Marca o tipo
            el.setAttribute('data-x', cx);
            el.setAttribute('data-y', cy);
            el.style.transform = `translate(${cx}px, ${cy}px)`;
            el.innerHTML = html;
            world.appendChild(el);
            return el;
        };

        // --- ROTEADOR DE DUPLO CLIQUE ---
        viewport.addEventListener('dblclick', (e) => {
            const card = e.target.closest('.card');
            if (!card) return;
            e.stopPropagation();

            const type = card.getAttribute('data-type') || 'default';
            
            // Se existir uma a√ß√£o registrada para esse tipo (ex: 'text'), executa
            if (window.pluginActions[type]) {
                window.pluginActions[type](card);
            } else {
                // Comportamento padr√£o: Entrar como pasta
                let title = card.querySelector('h2') ? card.querySelector('h2').innerText : 'Pasta';
                card.style.transform += " scale(1.1)";
                setTimeout(() => enterLayer(card.id, title, 'canvas', card), 100);
            }
        });

        // --- SISTEMA DE NAVEGA√á√ÉO E CAMADAS ---
        function saveCurrentLayerState() {
            if (layerStorage[currentLayerID].type === 'canvas') {
                const elements = Array.from(world.children).filter(el => el.classList.contains('card'));
                layerStorage[currentLayerID].elements = elements;
                layerStorage[currentLayerID].connections = [...currentConnections];
                layerStorage[currentLayerID].viewState = { x: state.x, y: state.y, scale: state.scale };
                layerStorage[currentLayerID].title = currentLayerID === 'root' ? 'Brain' : 'Pasta';
            }
        }

        function enterLayer(cardID, cardTitle, type, cardRef) {
            let parentTitle = 'Brain';
            if (currentLayerID !== 'root') {
                const active = document.querySelector('.crumb.active');
                if (active) parentTitle = active.innerText;
            }

            saveCurrentLayerState();
            layerStack.push({ id: currentLayerID, title: parentTitle, type: layerStorage[currentLayerID].type });

            currentLayerID = cardID;
            
            if (!layerStorage[currentLayerID]) {
                layerStorage[currentLayerID] = { type: type, elements: [], connections: [], viewState: { x: 0, y: 0, scale: 1 } };
            }

            if (type === 'text') activeDocCardReference = cardRef;

            updateBreadcrumbs(cardTitle);
            renderLayer(currentLayerID);
        }

        window.goToLayer = function(layerID) {
            if (layerID === currentLayerID) return;
            saveCurrentLayerState();
            const index = layerStack.findIndex(l => l.id === layerID);
            if (index !== -1) layerStack = layerStack.slice(0, index);
            else if (layerID === 'root') layerStack = [];
            currentLayerID = layerID;
            renderLayer(currentLayerID);
            updateBreadcrumbs();
        };

        function renderLayer(layerID) {
            const data = layerStorage[layerID];
            
            if (data.type === 'canvas') {
                docLayer.classList.remove('active');
                viewport.style.display = 'block';
                // Limpa e redesenha
                document.querySelectorAll('.card').forEach(c => c.remove());
                svgLayer.innerHTML = '';
                currentConnections = data.connections || [];
                data.elements.forEach(el => world.appendChild(el));
                currentConnections.forEach(conn => drawConnection(conn));
                
                // Restaura Zoom
                if (data.viewState) {
                    state.x = data.viewState.x; state.y = data.viewState.y; state.scale = data.viewState.scale;
                } else { state.x = 0; state.y = 0; state.scale = 1; }
                draw();

            } else if (data.type === 'text') {
                viewport.style.display = 'none';
                docLayer.classList.add('active');
                if (activeDocCardReference) {
                    docTitle.value = activeDocCardReference.querySelector('h2').innerText;
                    docBody.value = activeDocCardReference.querySelector('p').innerText;
                }
            }
        }

        // --- EDITOR DE TEXTO ---
        function syncDoc() {
            if (activeDocCardReference) {
                const val = docTitle.value || "Sem T√≠tulo";
                activeDocCardReference.querySelector('h2').innerText = val;
                activeDocCardReference.querySelector('p').innerText = docBody.value;
                document.querySelector('.crumb.active').innerText = val;
            }
        }
        docTitle.addEventListener('input', syncDoc);
        docBody.addEventListener('input', syncDoc);
        window.closeDocMode = () => window.goToLayer(layerStack[layerStack.length-1].id);

        function updateBreadcrumbs(override) {
            let html = layerStack.length === 0 ? `<span class="crumb active">Brain</span>` : '';
            if (layerStack.length > 0) {
                layerStack.forEach(l => html += `<span class="crumb" onclick="goToLayer('${l.id}')">${l.title}</span><span class="crumb-separator">/</span>`);
                let title = override;
                if (!title) {
                    if (layerStorage[currentLayerID].type === 'text') title = docTitle.value;
                    else title = "Pasta";
                }
                html += `<span class="crumb active">${title}</span>`;
            }
            breadcrumbsBar.innerHTML = html;
        }

        // --- INTERA√á√ÉO B√ÅSICA (ZOOM, PAN, DRAG) ---
        function draw() {
            world.style.transform = `translate(${state.x}px, ${state.y}px) scale(${state.scale})`;
            viewport.style.backgroundPosition = `${state.x}px ${state.y}px`;
            viewport.style.backgroundSize = `${40*state.scale}px ${40*state.scale}px`;
            document.getElementById('zoom-level').innerText = Math.round(state.scale*100)+'%';
        }
        viewport.addEventListener('mousedown', (e) => {
            if (e.button === 2) return;
            document.getElementById('context-menu').style.display='none';
            if (e.button === 1) { e.preventDefault(); state.isPanning=true; state.panStartX=e.clientX-state.x; state.panStartY=e.clientY-state.y; viewport.style.cursor='grabbing'; return; }
            if (e.button === 0) {
                const card = e.target.closest('.card');
                if (card) {
                    state.draggedCard = card; state.mouseStartX=e.clientX; state.mouseStartY=e.clientY;
                    state.cardStartX=parseFloat(card.getAttribute('data-x')); state.cardStartY=parseFloat(card.getAttribute('data-y'));
                    card.classList.add('dragging'); e.stopPropagation();
                } else {
                    state.isPanning=true; state.panStartX=e.clientX-state.x; state.panStartY=e.clientY-state.y; viewport.style.cursor='grabbing';
                }
            }
        });
        window.addEventListener('mousemove', (e) => {
            if (state.isPanning) { e.preventDefault(); state.x=e.clientX-state.panStartX; state.y=e.clientY-state.panStartY; draw(); }
            if (state.draggedCard) {
                e.preventDefault();
                const dx=e.clientX-state.mouseStartX; const dy=e.clientY-state.mouseStartY;
                const nx=state.cardStartX+(dx/state.scale); const ny=state.cardStartY+(dy/state.scale);
                state.draggedCard.style.transform=`translate(${nx}px, ${ny}px)`;
                state.draggedCard.setAttribute('data-x', nx); state.draggedCard.setAttribute('data-y', ny);
                updateLines(state.draggedCard.id);
            }
        });
        window.addEventListener('mouseup', () => {
            state.isPanning=false; if(state.draggedCard){state.draggedCard.classList.remove('dragging'); state.draggedCard=null;} viewport.style.cursor='default';
        });
        viewport.addEventListener('wheel', (e) => {
            e.preventDefault(); const d=-Math.sign(e.deltaY); const s=Math.min(Math.max(0.1, state.scale+(d*0.1)), 5);
            const mx=e.clientX; const my=e.clientY;
            state.x-=(mx-state.x)*(s/state.scale-1); state.y-=(my-state.y)*(s/state.scale-1);
            state.scale=s; draw();
        }, {passive:false});

        // --- CONEX√ïES E MENU CONTEXTO ---
        function updateLines(id) { currentConnections.forEach(c => { if(c.from===id || c.to===id) drawSVGPath(c.line, document.getElementById(c.from), document.getElementById(c.to)); }); }
        function drawConnection(conn) {
            const path = document.createElementNS('http://www.w3.org/2000/svg','path'); path.className='connector-line'; svgLayer.appendChild(path); conn.line=path;
            const el1=document.getElementById(conn.from); const el2=document.getElementById(conn.to);
            if(el1&&el2) drawSVGPath(path, el1, el2);
        }
        function drawSVGPath(path, el1, el2) {
            if(!el1 || !el2) return;
            const off=50000;
            const x1=parseFloat(el1.getAttribute('data-x'))+el1.offsetWidth/2; const y1=parseFloat(el1.getAttribute('data-y'))+el1.offsetHeight/2;
            const x2=parseFloat(el2.getAttribute('data-x'))+el2.offsetWidth/2; const y2=parseFloat(el2.getAttribute('data-y'))+el2.offsetHeight/2;
            const sx=x1+off; const sy=y1+off; const ex=x2+off; const ey=y2+off; const dist=Math.abs(ex-sx)*0.5;
            path.setAttribute('d', `M ${sx} ${sy} C ${sx+dist} ${sy}, ${ex-dist} ${ey}, ${ex} ${ey}`);
        }

        window.addEventListener('contextmenu', (e) => {
            e.preventDefault(); const card = e.target.closest('.card');
            if (card) { contextTargetID=card.id; showContextMenu(e.clientX, e.clientY); } else document.getElementById('context-menu').style.display='none';
        });

        function showContextMenu(x, y) {
            const menu = document.getElementById('context-menu'); menu.style.display='block'; menu.style.left=x+'px'; menu.style.top=y+'px'; menu.innerHTML='';
            const btnConn = document.createElement('div'); btnConn.className='menu-item'; btnConn.innerText='üîó Conectar'; 
            btnConn.onclick=()=>{ 
                document.getElementById('connection-picker').style.display='block'; 
                document.getElementById('picker-list').innerHTML=''; 
                document.querySelectorAll('.card').forEach(c=>{ if(c.id!==contextTargetID){ 
                    const d=document.createElement('div'); d.className='picker-option'; d.innerText=c.querySelector('h2').innerText; 
                    d.onclick=()=>{ 
                        currentConnections.push({from:contextTargetID, to:c.id}); drawConnection(currentConnections[currentConnections.length-1]); 
                        document.getElementById('connection-picker').style.display='none'; 
                    }; 
                    document.getElementById('picker-list').appendChild(d); 
                }}); menu.style.display='none'; 
            };
            menu.appendChild(btnConn);

            const btnDel = document.createElement('div'); btnDel.className='menu-item'; btnDel.innerText='üóëÔ∏è Excluir'; btnDel.style.color='#ff5555';
            btnDel.onclick=()=>{
                const c = document.getElementById(contextTargetID); if(c) c.remove();
                currentConnections.forEach(conn => { if(conn.from===contextTargetID || conn.to===contextTargetID) conn.line.remove(); });
                currentConnections = currentConnections.filter(conn => conn.from!==contextTargetID && conn.to!==contextTargetID);
                menu.style.display='none';
            };
            menu.appendChild(btnDel);
        }
        window.closePicker = () => document.getElementById('connection-picker').style.display='none';

        // =========================================================
        // 2. AQUI COME√áAM OS PLUGINS (INCLU√çDOS PARA FUNCIONAR)
        // =========================================================

        // Inicializa
        draw();
    </script><script src="plugins/plugin-texto.js"></script>
</body>
</html>
